<!DOCTYPE html>
<html lang="en">
<head>
  <title>Execution Methodology Builder - Home</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
  <style>
    body, h1, h2, h3, h4, h5 { font-family: 'Poppins', sans-serif; }
    body { margin: 0; padding: 0; font-size: 16px; }
    .top-right-button { position: absolute; top: 20px; right: 30px; z-index: 4; }
    .w3-main { margin-left: 300px; margin-right: 40px; padding-top: 60px; }
    #error-banner { display: none; position: fixed; top: 0; width: 100%; z-index: 5; }
    #chat-container { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #fff; }
    .message { margin: 10px 0; }
    .message.user { text-align: right; color: #007bff; }
    .message.assistant { text-align: left; color: #333; }
    #chat-form { display: flex; margin-top: 10px; }
    #chat-input { flex: 1; padding: 8px; }
    #chat-submit { padding: 8px 16px; }
    #methodology-output { margin-top: 20px; padding: 10px; background: #f9f9f9; border: 1px solid #ddd; white-space: pre-wrap; }
    #save-btn { margin-top: 10px; }
  </style>
</head>
<body>
  <!-- Error Banner -->
  <div id="error-banner" class="w3-panel w3-red">
    <span onclick="this.parentElement.style.display='none'" class="w3-button w3-display-topright">&times;</span>
    <p id="error-message"></p>
  </div>

  <!-- Sign Out -->
  <div class="top-right-button">
    <button id="signoutBtn" class="w3-button w3-red">Sign Out</button>
  </div>

  <!-- Sidebar -->
  <nav id="mySidebar" class="w3-sidebar w3-light-grey w3-top w3-collapse w3-large w3-padding" style="width:300px;z-index:3;">
    <div class="w3-container w3-blue">
      <h4 id="user-name">User Name</h4>
      <p id="user-position">Position</p>
      <p id="user-company">Company</p>
    </div>
    <div class="w3-bar-block">
      <button class="w3-bar-item w3-button w3-hover-blue" id="btn-create">Create Plan</button>
      <button class="w3-bar-item w3-button w3-hover-blue" id="btn-past">Past Plans</button>
    </div>
  </nav>
  <div class="w3-overlay w3-hide-large" id="myOverlay" onclick="w3_close()"></div>

  <!-- Main -->
  <div class="w3-main">
    <!-- Create -->
    <section id="create" class="w3-container" style="display:none;">
      <h2>Create Execution Methodology</h2>
      <div id="chat-container"></div>
      <form id="chat-form">
        <input id="chat-input" type="text" placeholder="Type your answer..." required />
        <button id="chat-submit" type="submit" class="w3-button w3-green">Next</button>
      </form>
      <div id="methodology-output" style="display:none;"></div>
      <button id="save-btn" class="w3-button w3-blue" style="display:none;">Save Methodology</button>
    </section>

    <!-- Past -->
    <section id="past" class="w3-container" style="display:none;">
      <h2>Past Execution Methodologies</h2>
      <ul id="past-list" class="w3-ul w3-card-4"></ul>
    </section>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const supabase = createClient(
      'https://vgiyutkufqgfgvixkhqz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnaXl1dGt1ZnFnZmd2aXhraHF6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDM2NjksImV4cCI6MjA2NDAxOTY2OX0.siQnaghNgiZpSj5p5LriQHN1ZkUs4DY7bdPSzD-mCrg'
    );

    // DOM refs
    const btnCreate = document.getElementById('btn-create');
    const btnPast = document.getElementById('btn-past');
    const sections = {
      create: document.getElementById('create'),
      past: document.getElementById('past')
    };
    const chatC = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const outputDiv = document.getElementById('methodology-output');
    const saveBtn = document.getElementById('save-btn');

    // Questions
    const questions = [
      '1) Please submit the Scope of Work text.',
      '2) Provide the sequence of tasks as per schedule.',
      '3) Provide your quality procedure details.',
      '4) Describe the technology used by your company.',
      '5) Provide safety details.',
      '6) Provide labor strategy details.',
      '7) Provide material/subcontractor plan details.'
    ];
    let answers = [];
    let qIndex = 0;

    function render(msg, cls) {
      const d = document.createElement('div');
      d.className = 'message ' + cls;
      d.textContent = msg;
      chatC.appendChild(d);
      chatC.scrollTop = chatC.scrollHeight;
    }
    function ask() {
      render(questions[qIndex], 'assistant');
    }

    async function generateMethodology() {
      render('Generating final execution methodology...', 'assistant');
      try {
        const payload = answers.map((ans, i) => `${questions[i]}\n${ans}`).join('\n\n');
        const res = await fetch(
          'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyCilMPa97LvCV6adkmw-q0VICslksVYMoE',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                {
                  role: 'user',
                  parts: [
                    { text: `Please provide an execution methodology from a contractor perspective to satisfy the client, based on all questions and answers:\n\n${payload}` }
                  ]
                }
              ]
            })
          }
        );
        const js = await res.json();
        if (js.error) throw new Error(js.error.message);
        const candidates = js.result?.candidates || js.candidates;
        if (!candidates) throw new Error('No candidates returned');
        const exec = candidates[0].content.parts[0].text.trim();
        render(exec, 'assistant');
        outputDiv.textContent = exec;
        outputDiv.style.display = 'block';
        saveBtn.style.display = 'inline-block';
      } catch (err) {
        showError('AI generation failed: ' + err.message);
      }
    }

    chatForm.addEventListener('submit', async e => {
      e.preventDefault();
      const txt = chatInput.value.trim();
      if (!txt) return;
      render(txt, 'user');
      answers.push(txt);
      chatInput.value = '';
      qIndex++;
      if (qIndex < questions.length) ask();
      else generateMethodology();
    });

    saveBtn.onclick = async () => {
      const { error } = await supabase.from('execution_methodologies').insert({ methodology: outputDiv.textContent });
      if (error) showError('Save failed: ' + error.message);
      else alert('Methodology saved!');
    };

    async function loadPast() {
      const { data, error } = await supabase.from('execution_methodologies').select().order('created_at', { ascending: false });
      const ul = document.getElementById('past-list'); ul.innerHTML = '';
      if (error) return showError('Load past failed: ' + error.message);
      data.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item.methodology.substring(0, 100) + '...';
        li.onclick = () => {
          outputDiv.textContent = item.methodology;
          showSection('create');
          outputDiv.style.display = 'block';
          saveBtn.style.display = 'none';
        };
        ul.appendChild(li);
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const signoutBtn = document.getElementById('signoutBtn');
      signoutBtn.onclick = async () => {
        const { error } = await supabase.auth.signOut();
        if (error) showError('Sign out failed: ' + error.message);
        else location.href = 'index.html';
      };

      btnCreate.onclick = () => showSection('create');
      btnPast.onclick = () => showSection('past');

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        location.href = 'index.html';
        return;
      }
      const meta = session.user.user_metadata;
      document.getElementById('user-name').textContent = meta.full_name;
      document.getElementById('user-position').textContent = meta.position;
      document.getElementById('user-company').textContent = meta.company;

      showSection('create');
      ask();
    });

    function showError(msg) {
      document.getElementById('error-message').textContent = msg;
      document.getElementById('error-banner').style.display = 'block';
    }
  </script>
</body>
</html>
